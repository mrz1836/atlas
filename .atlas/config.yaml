# ATLAS Project Configuration
# Generated by atlas init on 2026-01-01 19:15:46
# This file overrides ~/.atlas/config.yaml for this project.
# Consider adding .atlas/config.yaml to .gitignore if it contains sensitive data.

ai:
  # AI agent/CLI to use: "claude", "gemini", or "codex"
  # Default: "claude"
  agent: claude

  # AI model to use
  # Claude: "sonnet", "opus", or "haiku"
  # Gemini: "flash" or "pro"
  # Codex: "codex", "max", or "mini"
  # Default: "sonnet" for claude, "flash" for gemini, "codex" for codex
  model: sonnet

  # Environment variable names containing API keys per provider
  # You can override the default env var for each provider
  # Defaults: claude=ANTHROPIC_API_KEY, gemini=GEMINI_API_KEY, codex=OPENAI_API_KEY
  api_key_env_vars:
    claude: ANTHROPIC_API_KEY_MRZ
    gemini: GEMINI_API_KEY
    codex: OPENAI_API_KEY

  # Maximum duration for AI operations (e.g., "30m", "1h")
  # Default: 30m
  timeout: 30m

  # Maximum number of conversation turns (DEPRECATED: use max_budget_usd instead)
  # Default: 10
  max_turns: 10

  # Maximum dollar amount for AI operations; 0 = unlimited
  # Default: 0
  max_budget_usd: 0

  # Activity feed verbosity level for AI operations
  # "low" = Phase changes only (Analyzing → Planning → Implementing)
  # "medium" = Phases + file operations + key decisions
  # "high" = Everything including thinking indicators, all file reads
  # Default: "medium"
  activity_verbosity: medium

  # Enable automatic model fallback when AI generation fails with format errors.
  # When true, if a model fails (e.g., haiku produces invalid format), the system
  # automatically tries the next model in the fallback chain (e.g., haiku → sonnet → opus).
  # Default: true
  fallback_enabled: true

  # Model fallback chains per agent.
  # When a model fails with format errors, the system tries the next model in the chain.
  # Models are ordered from fastest/cheapest to most capable.
  # Default: claude=[haiku, sonnet, opus], gemini=[flash, pro], codex=[mini, codex, max]
  fallback_models:
    claude:
      - haiku
      - sonnet
      - opus
    gemini:
      - flash
      - pro
    codex:
      - mini
      - codex
      - max

  # Agent fallback order (optional).
  # When all models for an agent fail, the system can try a different agent.
  # Empty by default (no cross-agent fallback).
  # Example: ["claude", "gemini"] would try Claude first, then Gemini if Claude fails.
  # fallback_agents: []

  # Maximum retry attempts per model before moving to the next model.
  # Default: 1 (try each model once before fallback)
  fallback_max_retries_per_model: 1

git:
  # Default base branch for creating feature branches
  # Default: "main"
  base_branch: master

  # Enable automatic git operations without user confirmation
  # Default: true
  auto_proceed_git: true

  # Name of the remote repository
  # Default: "origin"
  remote: origin

  # PR operation defaults (used by git steps in templates, can be overridden per-step)
  pr:
    # Default merge method for PRs: "squash", "merge", or "rebase"
    # Default: "squash"
    merge_method: squash

    # Delete the source branch after merging
    # Default: false (keep branch for reference)
    delete_branch: false

    # Use admin bypass when branch protection blocks merge
    # WARNING: This bypasses required status checks - use with caution
    # Default: false
    admin_bypass: false

    # Default review event type for add_pr_review: "APPROVE", "REQUEST_CHANGES", or "COMMENT"
    # Default: "APPROVE"
    review_event: APPROVE

worktree:
  # Base directory where worktrees are created; empty = default location
  # Default: ""
  base_dir: ""

  # Suffix appended to worktree directory names
  # Default: ""
  naming_suffix: ""

templates:
  # Name of the default template when none is specified
  # Default: ""
  default_template: "task"

  # Map of custom template names to their file paths
  # Example: { "my-template": "/path/to/template.yaml" }
  # Default: {}
  custom_templates: {}

  # Optional: Override branch prefixes for templates
  # Default built-ins: bugfix="fix", feature="feat", commit="chore"
  # branch_prefixes:
  #   bugfix: fix
  #   feature: feat
  #   commit: chore

ci:
  # How often to check CI status (e.g., "30s", "2m")
  # Default: 2m
  poll_interval: 30s

  # Initial grace period before starting to poll CI (e.g., "1m", "2m")
  # Default: 2m
  grace_period: 1m

  # Maximum duration to wait for CI completion (e.g., "20m", "30m")
  # Default: 30m
  timeout: 20m

  # List of CI workflow names that must pass; empty = all workflows
  # Example: ["build", "test", "lint"]
  # Default: []
  # required_workflows: []

validation:
  # Maximum duration for each validation command (e.g., "5m", "10m")
  # Set to 30m to accommodate race detection tests (magex test:race) which take 25+ minutes
  # This matches the timeout configured in .mage.yaml
  # Default: 5m
  timeout: 30m

  # Run validation commands in parallel
  # Default: true
  parallel_execution: true

  # Enable AI-assisted retry when validation fails
  # Default: true
  ai_retry_enabled: true

  # Maximum number of AI retry attempts
  # Default: 3
  max_ai_retry_attempts: 2

  # Validation commands to run at various stages
  # Fields ordered by execution: pre_commit → format → lint → test → custom_pre_pr
  commands:
    # Commands run before committing (runs first)
    # Default: []
    pre_commit:
      - go-pre-commit run --all-files

    # Commands that format code (run with --fix semantics)
    # Default: []
    format:
      - magex format:fix

    # Commands that lint code
    # Default: []
    lint:
      - magex lint

    # Commands that run tests
    # Default: []
    test:
      - magex test:race

    # Custom commands to run before creating a PR
    # Default: []
    custom_pre_pr: []

notifications:
  # Enable terminal bell for important events
  # Default: true
  bell: true

  # Events that trigger notifications
  # Available: "awaiting_approval", "validation_failed", "ci_failed", "github_failed"
  # Default: all events
  events:
    - awaiting_approval
    - validation_failed
    - ci_failed
    - github_failed

smart_commit:
  # Agent for commit message generation; empty = uses ai.agent setting
  # Valid values: "claude", "gemini", "codex"
  # Default: "" (uses ai.agent)
  agent: "claude"

  # Model for commit message generation; empty = uses ai.model setting
  # Default: ""
  model: "haiku"

  # Timeout for AI commit message generation (e.g., "30s", "1m")
  # If AI takes longer, it will timeout and fall back to template generation
  # Default: 30s
  timeout: 30s

  # Maximum number of retry attempts for AI generation
  # Retries use exponential backoff to handle transient failures
  # Default: 2
  max_retries: 2

  # Exponential backoff factor for retries
  # Each retry timeout = previous_timeout * retry_backoff_factor
  # Example: With timeout=30s and factor=1.5, retries use 30s, 45s, 67.5s...
  # Default: 1.5
  retry_backoff_factor: 1.5

pr_description:
  # Agent for PR description generation; empty = uses ai.agent setting
  # Valid values: "claude", "gemini", "codex"
  # Default: "" (uses ai.agent)
  agent: "claude"

  # Model for PR description generation; empty = uses ai.model setting
  # Default: ""
  model: "haiku"

approval:
  # Default message for approve + merge + close operations
  # Default: "Approved and Merged by ATLAS"
  merge_message: "LGTM!"

verify:
  # Permission mode for AI verification steps
  # "plan" = read-only sandbox mode (recommended, default)
  # "" = full access (not recommended - allows destructive operations)
  # Default: "plan"
  permission_mode: plan

  # Verification checks to run (affects verify step speed)
  # Available: "code_correctness", "test_coverage", "garbage_files", "security"
  # Default: ["code_correctness"] (fast - ~10-20s)
  # Full: ["code_correctness", "test_coverage", "garbage_files", "security"] (~60-90s)
  # Note: garbage_files is already handled by smart_commit, so it's redundant here
  checks:
    - code_correctness
    # - test_coverage    # Enable for test coverage checks
    # - garbage_files    # Enable for garbage file detection (redundant with smart_commit)
    # - security         # Enable for security vulnerability scanning

#------------------------------------------------------------------------------
# Operation-Specific AI Settings
#------------------------------------------------------------------------------
# Override ai.agent/model for specific operations across ALL templates.
# Priority: step.Config > operations.{type} > ai.{agent,model}
operations:
  # Analysis: Deep reasoning for bug analysis, root cause identification.
  # Used by: bugfix template "analyze" step, feature spec analysis.
  analyze:
    agent: claude
    model: opus # Best reasoning capability
    timeout: 20m
    permission_mode: plan # Read-only

  # Implementation: Code generation and modification.
  # Used by: all templates "implement" step.
  implement:
    agent: claude
    model: sonnet # Balance of speed and capability
    timeout: 30m
    permission_mode: "" # Full access for implementation

  # Verification: Cross-validation using different AI perspective.
  # Used by: verify step when --verify flag is used.
  verify:
    agent: gemini # Different agent = diverse perspective
    model: flash # Fast checks
    timeout: 5m
    permission_mode: plan # Read-only

  # Validation retry: Fix lint/test/format errors.
  # Used when: validation fails and ai_retry_enabled=true.
  validation_retry:
    agent: claude
    model: sonnet
    timeout: 15m
    max_attempts: 3 # Override validation.max_ai_retry_attempts

  # SDD: Speckit specification-driven development.
  # Used by: feature template specify/plan/tasks/implement steps.
  sdd:
    agent: claude
    model: opus # Complex spec reasoning
    timeout: 25m

  # CI failure: Analyze and fix CI failures.
  # Used when: ci_wait step fails and retry is attempted.
  ci_failure:
    agent: claude
    model: sonnet
    timeout: 10m

hooks:
  # Cryptographic provider configuration
  crypto:
    # Provider selection: "native" (fast, simple) or other future providers
    # Default: "native"
    provider: native
